<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PAPI SPESE SUMMER 2025</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2pdf.js per esportare in PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; padding:0; background:#111; color:#fff; font-family:sans-serif; }
    .container { display:flex; flex-wrap: wrap; padding:1rem; }
    .form-col { flex:1 1 320px; padding-right:1rem; }
    .chart-col { flex:1 1 320px; position:relative; }
    h1, h2 { margin-top:0; }
    label { display:block; margin:0.5rem 0 0.2rem; }
    input, select, button { width:100%; padding:0.5rem; border:none; border-radius:4px; font-size:1rem; }
    input, select { background:#222; color:#fff; }
    button { cursor:pointer; margin-top:0.5rem; }
    .btn-add { background:#006bff; color:#fff; }
    .btn-save { background:#28a745; color:#fff; }
    .btn-clear { background:#dc3545; color:#fff; }
    .archive-list { width:100%; margin-top:2rem; }
    .card { background:#1e1e1e; padding:1rem; margin-bottom:1rem; border-radius:6px; }
    .card-header { display:flex; justify-content:space-between; align-items:center; }
    .btn-archive-delete { background:#c62828; color:#fff; padding:0.3rem 0.6rem; font-size:0.9rem; border-radius:4px; }
    .btn-archive-pdf { background:#3949ab; color:#fff; padding:0.3rem 0.6rem; font-size:0.9rem; border-radius:4px; margin-left:0.5rem; }
    /* Chart area */
    canvas { background:transparent !important; }
  </style>
</head>
<body>

  <h1 style="text-align:center; margin:1rem 0;">PAPI SPESE <span style="color:#ffc107;">SUMMER 2025</span></h1>
  <div class="container">

    <!-- colonna form -->
    <div class="form-col">
      <form id="spesaForm">
        <label for="giorno">Giorno</label>
        <select id="giorno">
          <option>VenerdÃ¬</option>
          <option>Sabato</option>
          <option>Domenica</option>
          <option>Extra</option>
        </select>

        <label for="descrizione">Descrizione Serata</label>
        <input id="descrizione" placeholder="Es: Opening, DJ Guestâ€¦" />

        <label for="data">Data</label>
        <input id="data" type="date" value="" />

        <hr style="border:1px solid #333; margin:1rem 0;">

        <h2 style="font-size:1.1rem; color:#bbb;">Dettaglio Spese</h2>
        <label for="voce">Voce di spesa</label>
        <input id="voce" placeholder="Es: DJ, PRâ€¦" />

        <label for="importo">Importo</label>
        <input id="importo" type="number" min="0" value="0" />

        <button type="button" class="btn-add" id="btnAddSpesa">Aggiungi Spesa</button>

        <ul id="listaSpese" style="margin:1rem 0 0 1rem; list-style:disc;"></ul>

        <label for="pos">POS</label>
        <input id="pos" type="number" min="0" value="0" />

        <label for="contante">Contante</label>
        <input id="contante" type="number" min="0" value="0" />

        <p style="font-weight:bold; margin-top:1rem;">Totale Incasso: <span id="totaleIncasso">0.00</span> â‚¬</p>

        <button type="button" class="btn-save" id="btnSaveArchivio">Salva e Archivia Serata</button>
        <button type="button" class="btn-clear" id="btnClearForm">Svuota Serata</button>
      </form>
    </div>

    <!-- colonna grafico -->
    <div class="chart-col">
      <h2 style="margin-top:0; color:#fff;">Composizione Incasso</h2>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <!-- Archivio -->
  <div class="archive-list" id="archivio"></div>

  <script>
    // riferimenti
    const giornoEl = document.getElementById('giorno');
    const descEl   = document.getElementById('descrizione');
    const dataEl   = document.getElementById('data');
    const voceEl   = document.getElementById('voce');
    const impEl    = document.getElementById('importo');
    const posEl    = document.getElementById('pos');
    const contEl   = document.getElementById('contante');
    const listaSpeseEl = document.getElementById('listaSpese');
    const totIncEl = document.getElementById('totaleIncasso');
    const btnAddSpesa    = document.getElementById('btnAddSpesa');
    const btnSaveArchivio= document.getElementById('btnSaveArchivio');
    const btnClearForm   = document.getElementById('btnClearForm');
    const archivioEl     = document.getElementById('archivio');

    // dati in memoria
    let spese = [];
    let pieChart;

    // init data
    if (!dataEl.value) {
      const today = new Date().toISOString().slice(0,10);
      dataEl.value = today;
    }

    // costruisce il grafico
    function initChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['POS','Contante','Spese'],
          datasets: [{
            data: [0,0,0],
            backgroundColor: ['#4db6ac','#42a5f5','#ef5350']
          }]
        },
        options: {
          plugins:{ legend:{ labels:{ color:'#fff' } } }
        }
      });
    }

    // aggiorna grafico
    function updateChart() {
      const totSpese = spese.reduce((s,e)=>s+e.importo,0);
      const pos = parseFloat(posEl.value)||0;
      const cont = parseFloat(contEl.value)||0;
      pieChart.data.datasets[0].data = [pos,cont,totSpese];
      pieChart.update();
      const inc = pos+cont+totSpese;
      totIncEl.textContent = inc.toFixed(2);
    }

    // aggiungi spesa
    btnAddSpesa.onclick = () => {
      const v = voceEl.value.trim();
      const i = parseFloat(impEl.value)||0;
      if (!v||i<=0) return alert('Voce e importo validi');
      spese.push({ voce:v, importo:i });
      const li = document.createElement('li');
      li.textContent = `${v}: â‚¬${i.toFixed(2)}`;
      listaSpeseEl.append(li);
      voceEl.value=''; impEl.value=0;
      updateChart();
    };

    // salva in archivio
    btnSaveArchivio.onclick = () => {
      const serata = {
        giorno: giornoEl.value,
        descr:  descEl.value.trim(),
        data:   dataEl.value,
        spese:  [...spese],
        pos:    parseFloat(posEl.value)||0,
        cont:   parseFloat(contEl.value)||0,
        totale: parseFloat(totIncEl.textContent)||0
      };
      const arch = JSON.parse(localStorage.getItem('archivio')||'[]');
      arch.push(serata);
      localStorage.setItem('archivio', JSON.stringify(arch));
      alert('Serata archiviata!');
      caricaArchivio();
      btnClearForm.click();
    };

    // svuota form
    btnClearForm.onclick = () => {
      spese=[]; listaSpeseEl.innerHTML=''; posEl.value=0; contEl.value=0;
      totIncEl.textContent='0.00'; descEl.value=''; // giorno e data li lascio
      updateChart();
    };

    // elimina singola serata
    function deleteSerata(idx) {
      const arch = JSON.parse(localStorage.getItem('archivio')||'[]');
      arch.splice(idx,1);
      localStorage.setItem('archivio', JSON.stringify(arch));
      caricaArchivio();
    }

    // esporta in PDF una card
    function exportPDF(cardEl, filename='serata.pdf') {
      html2pdf().set({ margin:10, filename, image:{ type:'jpeg', quality:0.98 } })
        .from(cardEl).save();
    }

    // costruisce elenco archivio
    function caricaArchivio() {
      archivioEl.innerHTML = '<h2>Archivio Serate</h2>';
      const arch = JSON.parse(localStorage.getItem('archivio')||'[]');
      arch.forEach((s,i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <strong>${s.data} â€“ ${s.descr||s.giorno}</strong>
            <span>
              <button class="btn-archive-delete" data-idx="${i}">âœ–</button>
              <button class="btn-archive-pdf"    data-idx="${i}">ðŸ“„</button>
            </span>
          </div>
          <p>Spese:</p>
          <ul>${s.spese.map(e=>`<li>${e.voce}: â‚¬${e.importo.toFixed(2)}</li>`).join('')}</ul>
          <p>POS: â‚¬${s.pos.toFixed(2)}, Contante: â‚¬${s.cont.toFixed(2)}</p>
          <p><strong>Totale: â‚¬${s.totale.toFixed(2)}</strong></p>
        `;
        archivioEl.append(card);
        // delete
        card.querySelector('.btn-archive-delete')
            .addEventListener('click',()=> deleteSerata(i));
        // pdf
        card.querySelector('.btn-archive-pdf')
            .addEventListener('click',()=> exportPDF(card, `serata-${s.data}.pdf`));
      });
    }

    // quando cambiano pos o contante, aggiorna subito
    posEl.oninput = updateChart;
    contEl.oninput = updateChart;

    // inizializza tutto
    window.onload = () => {
      initChart();
      updateChart();
      caricaArchivio();
    };
  </script>
</body>
</html>
